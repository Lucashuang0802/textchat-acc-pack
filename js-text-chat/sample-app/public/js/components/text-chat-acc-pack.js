var TextChatAccPack=function(){var e,s,t,a,n,i,o,c=!1,r=!1,d="chat-container",m=function(s){s=s||{},imCharacterCount=s.charCountElement,e=s.acceleratorPack,t=s.sender,o=s.limitCharacterMessage||160,i=this},l=function(e){return uiLayout=['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+o+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="character-count">0</span>/'+o+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},u=function(e){e=document.querySelector(e)||document.body;var s=document.createElement("section");s.innerHTML=l(),a=s.querySelector("#messageBox"),n=s.querySelector("#messagesHolder"),a.onkeyup=M.bind(this),a.onkeydown=E.bind(this),e.appendChild(s),document.getElementById("sendMessage").onclick=function(){g(a.value)}},h=function(e){return s&&s.senderId===e.senderId&&moment(s.sentOn).fromNow()===moment(e.sentOn).fromNow()},g=function(e){_.isEmpty(e)||$.when(p(i._remoteParticipant,e)).then(function(s){v({senderId:t.id,alias:t.alias,message:e,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){i._handleMessageError(e)})},p=function(s,a){var n=new $.Deferred,i={text:a,sender:{id:t.id,alias:t.alias},sentOn:Date.now()};return console.log(e.getSession()),void 0===s?e.getSession().signal({type:"text-chat",data:i},function(e){if(e){if(e.message="Error sending a message. ",413===e.code){var s=e.message+"The chat message is over size limit.";e.message=s}else if(500===e.code){var s=e.message+"Check your network connection.";e.message=s}n.reject(e)}else console.log("Message sent"),n.resolve(i)}):e.getSession().signal({type:"text-chat",data:i,to:s},function(e){e?(console.log("Error sending a message"),n.resolve(e)):(console.log("Message sent"),n.resolve(i))}),n.promise()},v=function(e){if(h(e)){$(".wms-item-text").last().append("<span>"+e.message+"</span>");var a=$(n);a[0].scrollTop=a[0].scrollHeight,T()}else x(t.id,t.alias,e.message,e.sentOn);s=e},f=function(e){"string"==typeof e.data&&(e.data=JSON.parse(e.data)),h(e.data)?$(".wms-item-text").last().append("<span>"+e.data.text+"</span>"):x(e.data.sender.id,e.data.sender.alias,e.data.text,e.data.sentOn),s=e.data},w=function(e){if(console.log(e.code,e.message),500===e.code){var s=_.template($("#chatError").html());$(this.comms_elements.messagesView).append(s())}},x=function(e,s,a,i){var o=t.id===e?"wms-message-item wms-message-sent":"wms-message-item",c=C({username:s,message:a,messageClass:o,time:i}),r=$(n);r.append(c),T(),r[0].scrollTop=r[0].scrollHeight},C=function(e){var s=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return s},y=function(s){var t=e.getSession().connection.connectionId,a=s.from.connectionId;if(a!==t){var n=f(s);n&&"function"==typeof n&&n(s)}},T=function(){a.value="",$(imCharacterCount).text("0")},E=function(e){var s=13===e.which||13===e.keyCode;!e.shiftKey&&s&&(e.preventDefault(),g.call(this,a.value))},M=function(){$(imCharacterCount).text(a.value.length)};return m.prototype={constructor:m,initTextChat:function(s){c=!0,r=!0,u.call(this,s),e.getSession().on("signal:text-chat",this._handleTextChat.bind(this))},showTextChat:function(){document.getElementById(d).classList.remove("hidden"),this.setDisplayTextChat(!0)},hideTextChat:function(){document.getElementById(d).classList.add("hidden"),this.setDisplayTextChat(!1)},getEnableTextChat:function(){return c},getDisplayTextChat:function(){return r},setDisplayTextChat:function(e){r=e},_handleTextChat:function(e){y.call(this,e)},_handleMessageError:function(e){w.call(this,e)}},m}();