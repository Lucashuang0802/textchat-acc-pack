(function(){var e,t,n;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),t=require("jquery"),window.jQuery=t,window.moment=require("moment"),require("kuende-livestamp"),n=require("opentok-solutions-logging")):(e=this._,t=this.$,window.jQuery=t,window.moment=this.moment,n=this.OTKAnalytics);var s,i,a,o,r,c,d,l,u={clientVersion:"js-vsol-1.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"End",actionOpen:"OpenTC",actionClose:"CloseTC",actionSendMessage:"Send Msg",actionReceiveMessage:"Receive Msg",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},m=function(){var e=window.location.href,t={clientVersion:u.clientVersion,source:e,componentId:u.componentId,name:u.name};a=new n(t);var s={sessionId:i.id,connectionId:i.connection.connectionId,partnerId:i.apiKey};a.addSessionInfo(s)},g=function(e,t){var n={action:e,variation:t};a.logEvent(n)},v=!1,h=!1,p=!1,f=!1,w=function(e,t){l&&l.triggerEvent(e,t)},C=function(){return['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+s.options.limitCharacterMessage+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="characterCount">0</span>/'+s.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},x=function(e){return!!c&&(c.sender.id===e.sender.id&&c.sender.id===e.sender.id)},S=function(){r.value="",t("#characterCount").text("0")},y=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},M=function(e,n,s,i){var a=o.id===e?"wms-message-item wms-message-sent":"wms-message-item",r=y({username:n,message:s,messageClass:a,time:i}),c=t(d);c.append(r),S(),c[0].scrollTop=c[0].scrollHeight},T=function(e){if(x(e)){t(".wms-item-text").last().append(["<span>",e.message,"</span>"].join(""));var n=t(d);n[0].scrollTop=n[0].scrollHeight,S()}else M(o.id,o.alias,e.message,e.sentOn);c=e,w("messageSent",e)},E=function(n){if(console.log(n.code,n.message),500===n.code){var i=e.template(t("#chatError").html());t(s.comms_elements.messagesView).append(i())}w("errorSendingMessage",n)},k=function(n,s){var a=new t.Deferred,r={text:s,sender:{id:o.id,alias:o.alias},sentOn:Date.now()};return g(u.actionSendMessage,u.variationAttempt),void 0===n?i.signal({type:"text-chat",data:JSON.stringify(r)},function(t){if(t){var n="Error sending a message. ";g(u.actionSendMessage,u.variationFailure),413===t.code?n+="The chat message is over size limit.":500===t.code&&(n+="Check your network connection."),a.reject(e.extend(e.omit(t,"message")),{message:n})}else console.log("Message sent"),g(u.actionSendMessage,u.variationSuccess),a.resolve(r)}):i.signal({type:"text-chat",data:JSON.stringify(r),to:n},function(e){e?(console.log("Error sending a message"),g(u.actionSendMessage,u.variationFailure),a.resolve(e)):(console.log("Message sent"),a.resolve(r),g(u.actionSendMessage,u.variationSuccess))}),a.promise()},I=function(n){e.isEmpty(n)||t.when(k(s._remoteParticipant,n)).then(function(){T({sender:{id:o.id,alias:o.alias},message:n,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){E(e)})},b=function(){var e=document.querySelector(s.options.textChatContainer)||document.body,n=document.createElement("section");n.innerHTML=C(),r=n.querySelector("#messageBox"),d=n.querySelector("#messagesHolder"),r.onkeyup=function(){t("#characterCount").text(r.value.length)},r.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),I(r.value))},e.appendChild(n),document.getElementById("sendMessage").onclick=function(){I(r.value)},g(u.actionInitialize,u.variationSuccess)},j=function(e){var n=JSON.parse(e.data);x(n)?t(".wms-item-text").last().append(["<span>",n.text,"</span>"].join("")):M(n.sender.id,n.sender.alias,n.text,n.sentOn),c=n,g(u.actionReceiveMessage,u.variationSuccess)},q=function(e){var t=i.connection.connectionId,n=e.from.connectionId;if(n!==t){var s=j(e);s&&"function"==typeof s&&s(e),w("messageReceived",e)}},O=function(){v=!0,h=!0,p=!0,b(),w("showTextChat"),i.on("signal:text-chat",q),g(u.actionStart,u.variationSuccess)},L=function(){document.querySelector(s.options.textChatContainer).classList.remove("hidden"),h=!0,w("showTextChat"),g(u.actionOpen,u.variationSuccess)},A=function(){document.querySelector(s.options.textChatContainer).classList.add("hidden"),h=!1,w("hideTextChat"),g(u.actionClose,u.variationSuccess),g(u.actionEnd,u.variationSuccess)},H=function(){var e=document.querySelector(s.options.controlsContainer),t=document.createElement("div");t.innerHTML='<div class="video-control circle text-chat enabled" id="enableTextChat"></div>';var n=t.firstChild;e.appendChild(n),f=!0,n.onclick=function(){p?h?A():L():O()}},P=function(t){if(!t.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},s=function(){return[n(),i.id,n()].join("")};return i=e.property("session")(t),l=e.property("accPack")(t),o=e.defaults(t.sender||{},{id:s(),alias:["User",n()].join(" ")}),e.defaults(e.omit(t,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer"})},D=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];l&&l.registerEvents(e)},N=function(){l&&(l.registerEventListener("startCall",function(){f?document.querySelector("#enableTextChat").classList.remove("hidden"):H()}),l.registerEventListener("endCall",function(){document.getElementById("enableTextChat").classList.add("hidden"),h&&A()}))},R=function(t){s=this,s.options=P(t),m(),e.property("_this.options.limitCharacterMessage")(t)&&g(u.actionSetMaxLength,u.variationSuccess),H(),D(),N()};R.prototype={constructor:R,isEnabled:function(){return v},isDisplayed:function(){return h},showTextChat:function(){L()},hideTextChat:function(){A()}},"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):this.TextChatAccPack=R}).call(this);